<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte du Monde Interactive</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2196F3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="CarteInteractive">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <!-- Styles globaux -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="components/AuthPopup/AuthPopup.css">
    <link rel="stylesheet" href="components/AddDestination/AddDestination.css">
    <link rel="stylesheet" href="components/AddDestination/addActivity/AddActivity.css">
</head>
<body>
    <div id="map"></div>
    
    <button class="auth-btn" onclick="AuthPopup.show()">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
        <polyline points="10 17 15 12 10 7"></polyline>
        <line x1="15" y1="12" x2="3" y2="12"></line>
    </svg>
</button>
    
    <button class="add-btn" onclick="AddDestination.show()">+</button>
    
    <!-- Conteneur pour le popup de connexion -->
    <div id="authPopupContainer"></div>
    
    <!-- Conteneur pour le panneau d'ajout -->
    <div id="addPanelContainer"></div>
    
    <!-- Conteneur pour le panneau utilisateur -->
    <div id="userPanel" class="user-panel">
        <div class="user-info">
            <button class="logout-btn" onclick="handleLogout()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Contr√¥les de carte -->
    <div class="controls">
        <select id="mapStyle" onchange="changeMapStyle()">
            <option value="osm">OpenStreetMap</option>
            <option value="satellite">Satellite</option>
            <option value="terrain">Terrain</option>
            <option value="dark">Mode sombre</option>
        </select>
    </div>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <!-- Firebase SDK v12 -->
    <script type="module">
        // Importer les modules Firebase n√©cessaires
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, getDoc, getDocs, query, where, orderBy, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBdO1hs92ZlaVNeefwu2Yqhdb-2nDLo4Vk",
            authDomain: "pwa-voyage-asie.firebaseapp.com",
            projectId: "pwa-voyage-asie",
            storageBucket: "pwa-voyage-asie.firebasestorage.app",
            messagingSenderId: "952612056038",
            appId: "1:952612056038:web:318e446aa787783f77c427",
            measurementId: "G-E0WFHDHCST"
        };
        
        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Exporter globalement pour notre service
        window.firebase = {
            app,
            db,
            auth,
            initializeApp,
            getFirestore,
            collection,
            doc,
            addDoc,
            updateDoc,
            getDoc,
            getDocs,
            query,
            where,
            orderBy,
            serverTimestamp,
            arrayUnion,
            getAuth,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        };
        
        // Initialiser notre service Firebase
        console.log('Modules Firebase charg√©s, initialisation du service...');
        if (window.firebaseService) {
            window.firebaseService.initialize();
        }
        
        // Test de configuration Firebase
        setTimeout(() => {
            console.log('=== TEST CONFIGURATION FIREBASE ===');
            console.log('Firebase disponible:', typeof window.firebase !== 'undefined');
            console.log('Service initialis√©:', window.firebaseService.isInitialized);
            console.log('Auth disponible:', typeof window.firebase.auth !== 'undefined');
            console.log('getDoc disponible:', typeof window.firebase.getDoc !== 'undefined');
            console.log('User connect√©:', window.firebaseService.isAuthenticated());
            console.log('=====================================');
        }, 2000);
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => console.log('Service Worker enregistr√©'))
                .catch(error => console.log('Service Worker erreur:', error));
        }
    </script>
    
    <!-- Firebase Service -->
    <script src="firebaseService.js"></script>
    
    <!-- AuthPopup Script -->
    <script src="components/AuthPopup/AuthPopup.js"></script>
    
    <!-- Component Manager -->
    <script type="module">
        // Importer les composants
        import { ComponentManager } from './components/ComponentManager.js';
        import { AddDestination } from './components/AddDestination/AddDestination.js';
        
        // Enregistrer les composants
        ComponentManager.register('addDestination', AddDestination);
        
        // Exporter globalement
        window.ComponentManager = ComponentManager;
        window.AddDestination = AddDestination;
        
        // Initialiser les composants quand le DOM est pr√™t
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM pr√™t, initialisation des composants...');
            
            // Initialiser AuthPopup
            if (window.AuthPopup) {
                window.AuthPopup.init('authPopupContainer');
            }
            
            await ComponentManager.initAll();
        });
    </script>
    
    <script>
        // Variables globales
        let searchTimeout;
        let currentSelectedResult;
        let isSearching = false;
        let isOnline = navigator.onLine;
        let destinationMarkers = []; // Stocker les marqueurs de destinations
        
        // Initialisation de la carte
        let map = L.map('map', {
            center: [20, 0],
            zoom: 2,
            minZoom: 2,
            maxZoom: 18,
            worldCopyJump: true,
            zoomControl: false
        });
        
        // Diff√©rents styles de cartes
        const mapStyles = {
            osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri'
            }),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenTopoMap'
            }),
            dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© CartoDB'
            })
        };
        
        // Style par d√©faut
        let currentLayer = mapStyles.osm;
        currentLayer.addTo(map);
        
        // Ajouter les contr√¥les de zoom
        L.control.zoom({
            position: 'bottomright'
        }).addTo(map);
        
        // Fonctions de carte
        function changeMapStyle() {
            const style = document.getElementById('mapStyle').value;
            map.removeLayer(currentLayer);
            currentLayer = mapStyles[style];
            currentLayer.addTo(map);
        }
        
        // Fonction pour afficher les destinations sur la carte
        async function displayDestinationsOnMap() {
            // Effacer les marqueurs existants
            destinationMarkers.forEach(marker => map.removeLayer(marker));
            destinationMarkers = [];
            
            if (!window.firebaseService.isAuthenticated()) {
                console.log('üîí Utilisateur non connect√©');
                return;
            }
            
            try {
                const destinations = await window.firebaseService.getDirectDestinations();
                
                if (destinations.length > 0) {
                    destinations.forEach((destination) => {
                        if (typeof destination === 'object' && destination.location && destination.location.lat && destination.location.lng) {
                            const name = destination.name || 'Destination sans nom';
                            
                            let popupContent = `
                                <div style="min-width: 200px;">
                                    <h4 style="margin: 0 0 5px 0; color: #333;">${name}</h4>`;
                            
                            if (destination.address && destination.address.trim() !== '') {
                                popupContent += `<p style="margin: 5px 0; color: #666;">${destination.address}</p>`;
                            }
                            
                            popupContent += `
                                    <p style="margin: 5px 0; font-size: 12px; color: #999;">Destination individuelle</p>
                                </div>`;
                            
                            const marker = L.marker([destination.location.lat, destination.location.lng])
                                .addTo(map)
                                .bindPopup(popupContent);
                            
                            destinationMarkers.push(marker);
                        }
                    });
                    
                    console.log(`‚úÖ ${destinationMarkers.length} marqueur(s) affich√©(s)`);
                    
                    // Ajuster la vue pour voir tous les marqueurs
                    const group = new L.featureGroup(destinationMarkers);
                    map.fitBounds(group.getBounds().pad(0.1));
                } else {
                    console.log('‚ùå Aucune destination √† afficher');
                }
                
            } catch (error) {
                console.error('‚ùå Erreur affichage destinations:', error);
            }
        }
        
        // Mettre √† jour l'affichage des destinations apr√®s connexion
        async function updateUserPanel() {
            const userPanel = document.getElementById('userPanel');
            
            if (window.firebaseService.isAuthenticated()) {
                const user = window.firebaseService.user;
                userPanel.style.display = 'flex';
                
                // V√©rifier et cr√©er l'itin√©raire si n√©cessaire
                await window.firebaseService.ensureUserItinerary();
                
                // Afficher les destinations sur la carte apr√®s connexion
                displayDestinationsOnMap();
                console.log('Panneau utilisateur affich√© pour:', user.email);
            } else {
                userPanel.style.display = 'none';
                
                // Effacer les marqueurs lors de la d√©connexion
                destinationMarkers.forEach(marker => map.removeLayer(marker));
                destinationMarkers = [];
            }
        }
        
        // V√©rifier l'√©tat de connexion au chargement
        window.firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                window.firebaseService.user = user;
                console.log('Utilisateur connect√©:', user.email);
                updateUserPanel();
            } else {
                window.firebaseService.user = null;
                console.log('Utilisateur d√©connect√©');
                updateUserPanel();
            }
        });
        
        // Fonctions de popup (compatibilit√©)
        function closePopup(popupId) {
            if (popupId === 'menuPopup') {
                MenuPopup.hide();
            }
        }
        
        // Fonction de d√©connexion
        function handleLogout() {
            console.log('Tentative de d√©connexion...');
            console.log('Firebase disponible:', !!window.firebase);
            console.log('Firebase.auth disponible:', !!window.firebase?.auth);
            console.log('signOut disponible:', !!window.firebase?.signOut);
            
            if (window.firebase && window.firebase.auth && window.firebase.signOut) {
                window.firebase.signOut(window.firebase.auth)
                    .then(() => {
                        console.log('D√©connexion r√©ussie');
                        updateUserPanel();
                        
                        // R√©afficher le bouton de connexion
                        const authBtn = document.querySelector('.auth-btn');
                        if (authBtn) {
                            authBtn.style.display = 'flex';
                        }
                    })
                    .catch((error) => {
                        console.error('Erreur de d√©connexion:', error);
                    });
            } else {
                console.error('Firebase non disponible pour la d√©connexion');
            }
        }
        
        // √âcouter les changements de connexion
        window.addEventListener('online', () => {
            isOnline = true;
            console.log('Connexion r√©tablie - API activ√©e');
        });
        
        window.addEventListener('offline', () => {
            isOnline = false;
            console.log('Connexion perdue - API d√©sactiv√©e');
        });
        
        // Support tactile pour mobile
        if ('ontouchstart' in window) {
            map.dragging.enable();
            map.touchZoom.enable();
            map.doubleClickZoom.enable();
            map.scrollWheelZoom.enable();
        }
        
        // Exporter les fonctions globalement
        window.displayDestinationsOnMap = displayDestinationsOnMap;
        window.updateUserPanel = updateUserPanel;
        window.changeMapStyle = changeMapStyle;
        window.map = map;
    </script>
</body>
</html>
