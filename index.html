<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte du Monde Interactive</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2196F3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="CarteInteractive">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <!-- Styles globaux -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="map"></div>
    
    <button class="menu-btn" onclick="MenuPopup.show()">
        <div class="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </button>
    
    <button class="add-btn" onclick="AddDestination.show()">+</button>
    
    <!-- Conteneur pour le menu popup -->
    <div id="menuPopupContainer"></div>
    
    <!-- Conteneur pour le panneau d'ajout -->
    <div id="addPanelContainer"></div>
    
    <!-- Conteneur pour le panneau utilisateur -->
    <div id="userPanel" class="user-panel">
        <div class="user-info">
            <span id="userEmail"></span>
            <button class="btn-secondary" onclick="MenuPopup.handleLogout()">Déconnexion</button>
        </div>
    </div>
    
    <!-- Contrôles de carte -->
    <div class="controls">
        <select id="mapStyle" onchange="changeMapStyle()">
            <option value="osm">OpenStreetMap</option>
            <option value="satellite">Satellite</option>
            <option value="terrain">Terrain</option>
            <option value="dark">Mode sombre</option>
        </select>
    </div>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <!-- Firebase SDK v12 -->
    <script type="module">
        // Importer les modules Firebase nécessaires
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, getDoc, getDocs, query, where, orderBy, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBdO1hs92ZlaVNeefwu2Yqhdb-2nDLo4Vk",
            authDomain: "pwa-voyage-asie.firebaseapp.com",
            projectId: "pwa-voyage-asie",
            storageBucket: "pwa-voyage-asie.firebasestorage.app",
            messagingSenderId: "952612056038",
            appId: "1:952612056038:web:318e446aa787783f77c427",
            measurementId: "G-E0WFHDHCST"
        };
        
        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Exporter globalement pour notre service
        window.firebase = {
            app,
            db,
            auth,
            initializeApp,
            getFirestore,
            collection,
            doc,
            addDoc,
            updateDoc,
            getDoc,
            getDocs,
            query,
            where,
            orderBy,
            serverTimestamp,
            arrayUnion,
            getAuth,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        };
        
        // Initialiser notre service Firebase
        console.log('Modules Firebase chargés, initialisation du service...');
        if (window.firebaseService) {
            window.firebaseService.initialize();
        }
        
        // Test de configuration Firebase
        setTimeout(() => {
            console.log('=== TEST CONFIGURATION FIREBASE ===');
            console.log('Firebase disponible:', typeof window.firebase !== 'undefined');
            console.log('Service initialisé:', window.firebaseService.isInitialized);
            console.log('Auth disponible:', typeof window.firebase.auth !== 'undefined');
            console.log('getDoc disponible:', typeof window.firebase.getDoc !== 'undefined');
            console.log('User connecté:', window.firebaseService.isAuthenticated());
            console.log('=====================================');
        }, 2000);
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => console.log('Service Worker enregistré'))
                .catch(error => console.log('Service Worker erreur:', error));
        }
    </script>
    
    <!-- Firebase Service -->
    <script src="firebaseService.js"></script>
    
    <!-- Component Manager -->
    <script type="module">
        // Importer les composants
        import { ComponentManager } from './components/ComponentManager.js';
        import { MenuPopup } from './components/MenuPopup/MenuPopup.js';
        import { AddDestination } from './components/AddDestination/AddDestination.js';
        
        // Enregistrer les composants
        ComponentManager.register('menuPopup', MenuPopup);
        ComponentManager.register('addDestination', AddDestination);
        
        // Exporter globalement
        window.ComponentManager = ComponentManager;
        window.MenuPopup = MenuPopup;
        window.AddDestination = AddDestination;
        
        // Initialiser les composants quand le DOM est prêt
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM prêt, initialisation des composants...');
            await ComponentManager.initAll();
        });
    </script>
    
    <script>
        // Variables globales
        let searchTimeout;
        let currentSelectedResult;
        let isSearching = false;
        let isOnline = navigator.onLine;
        let destinationMarkers = []; // Stocker les marqueurs de destinations
        
        // Initialisation de la carte
        let map = L.map('map', {
            center: [20, 0],
            zoom: 2,
            minZoom: 2,
            maxZoom: 18,
            worldCopyJump: true,
            zoomControl: false
        });
        
        // Différents styles de cartes
        const mapStyles = {
            osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri'
            }),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenTopoMap'
            }),
            dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '© CartoDB'
            })
        };
        
        // Style par défaut
        let currentLayer = mapStyles.osm;
        currentLayer.addTo(map);
        
        // Ajouter les contrôles de zoom
        L.control.zoom({
            position: 'bottomright'
        }).addTo(map);
        
        // Fonctions de carte
        function changeMapStyle() {
            const style = document.getElementById('mapStyle').value;
            map.removeLayer(currentLayer);
            currentLayer = mapStyles[style];
            currentLayer.addTo(map);
        }
        
        // Fonction pour afficher les destinations sur la carte
        async function displayDestinationsOnMap() {
            // Effacer les marqueurs existants
            destinationMarkers.forEach(marker => map.removeLayer(marker));
            destinationMarkers = [];
            
            if (!window.firebaseService.isAuthenticated()) {
                console.log('Utilisateur non connecté, pas de destinations à afficher');
                return;
            }
            
            try {
                console.log('Récupération des itinéraires pour affichage...');
                const itineraries = await window.firebaseService.getItineraries();
                console.log('Itinéraires trouvés:', itineraries);
                
                itineraries.forEach(itinerary => {
                    console.log(`Itinéraire: ${itinerary.nom}`);
                    console.log('Destinations dans itinéraire:', itinerary.destinations);
                    
                    // Les destinations sont stockées dans le champ "destinations" de l'itinéraire
                    if (itinerary.destinations && Array.isArray(itinerary.destinations)) {
                        itinerary.destinations.forEach((destination, index) => {
                            console.log(`Destination ${index}:`, destination);
                            
                            // Vérifier si c'est un objet complet ou juste un ID
                            if (typeof destination === 'object' && destination.location && destination.location.lat && destination.location.lng) {
                                // Créer un marqueur pour la destination
                                const marker = L.marker([destination.location.lat, destination.location.lng])
                                    .addTo(map)
                                    .bindPopup(`
                                        <div style="min-width: 200px;">
                                            <h4 style="margin: 0 0 5px 0; color: #333;">${destination.nom || destination.adresse}</h4>
                                            <p style="margin: 5px 0; color: #666;">${destination.adresse}</p>
                                            <p style="margin: 5px 0; font-size: 12px; color: #999;">Itinéraire: ${itinerary.nom}</p>
                                        </div>
                                    `);
                                
                                destinationMarkers.push(marker);
                                console.log(`✅ Marqueur ajouté pour: ${destination.nom} à [${destination.location.lat}, ${destination.location.lng}]`);
                            } else if (typeof destination === 'string') {
                                console.log(`⚠️ Destination ${index} est un ID, pas un objet complet:`, destination);
                                // TODO: Récupérer les données complètes de cette destination
                            } else {
                                console.log(`❌ Destination ${index} format invalide:`, destination);
                            }
                        });
                    } else {
                        console.log('❌ Aucune destination dans cet itinéraire ou format invalide');
                    }
                });
                
                console.log(`Total des marqueurs affichés: ${destinationMarkers.length}`);
                
                // Ajuster la vue pour voir tous les marqueurs
                if (destinationMarkers.length > 0) {
                    const group = new L.featureGroup(destinationMarkers);
                    map.fitBounds(group.getBounds().pad(0.1));
                } else {
                    console.log('❌ Aucun marqueur à afficher');
                }
                
            } catch (error) {
                console.error('Erreur affichage destinations:', error);
            }
        }
        
        // Mettre à jour l'affichage des destinations après connexion
        function updateUserPanel() {
            const userPanel = document.getElementById('userPanel');
            const userEmail = document.getElementById('userEmail');
            
            if (window.firebaseService.isAuthenticated()) {
                const user = window.firebaseService.user;
                userEmail.textContent = user.email;
                userPanel.style.display = 'flex';
                
                // Afficher les destinations sur la carte après connexion
                displayDestinationsOnMap();
            } else {
                userPanel.style.display = 'none';
                
                // Effacer les marqueurs lors de la déconnexion
                destinationMarkers.forEach(marker => map.removeLayer(marker));
                destinationMarkers = [];
            }
        }
        
        // Vérifier l'état de connexion au chargement
        window.firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                window.firebaseService.user = user;
                updateUserPanel();
                console.log('Utilisateur connecté:', user.email);
            } else {
                window.firebaseService.user = null;
                updateUserPanel();
                console.log('Utilisateur déconnecté');
            }
        });
        
        // Fonctions de popup (compatibilité)
        function closePopup(popupId) {
            if (popupId === 'menuPopup') {
                MenuPopup.hide();
            }
        }
        
        function closePopupOutside(event, popupId) {
            if (event.target === event.currentTarget) {
                if (popupId === 'menuPopup') {
                    MenuPopup.hide();
                }
            }
        }
        
        // Écouter les changements de connexion
        window.addEventListener('online', () => {
            isOnline = true;
            console.log('Connexion rétablie - API activée');
        });
        
        window.addEventListener('offline', () => {
            isOnline = false;
            console.log('Connexion perdue - API désactivée');
        });
        
        // Support tactile pour mobile
        if ('ontouchstart' in window) {
            map.dragging.enable();
            map.touchZoom.enable();
            map.doubleClickZoom.enable();
            map.scrollWheelZoom.enable();
        }
        
        // Exporter les fonctions globalement
        window.displayDestinationsOnMap = displayDestinationsOnMap;
        window.updateUserPanel = updateUserPanel;
        window.changeMapStyle = changeMapStyle;
        window.map = map;
    </script>
</body>
</html>
